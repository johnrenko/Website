---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('work');
  return entries.map((e) => ({ params: { id: e.id }, props: { entry: e } }));
}

const { entry } = Astro.props as { entry: any };
const { Content } = await entry.render();

// Function to get work-specific images with @2x support
function getWorkImages(workId: string) {
  // Static mapping of work IDs to their base image names (without extension)
  const workImageMap: Record<string, string[]> = {
    'livi-fr.mdx': [
      'Livi1-mobile',
      'Livi2-mobile',
      'Livi3-mobile',
      'Livi4-mobile',
      'Livi5-mobile',
      'Livi6-mobile',
      'Livi7-mobile',
      'Livi8-mobile',
      'Livi9-mobile',
      'Livi10-mobile',
      'Livi11-mobile',
      'Livi12-mobile',
      'Livi13',
      'Livi14'
    ],
    'paladin-fr.mdx': [
      'Paladin1',
      'Paladin2',
      'Paladin3',
      'Paladin4',
      'Paladin5',
      'Paladin6',
      'Paladin7'
    ],
    'quitoxil-fr.mdx': [
      'Quitoxil1-mobile',
      'Quitoxil2-mobile',
      'Quitoxil3-mobile',
      'Quitoxil4-mobile',
      'Quitoxil5-mobile',
      'Quitoxil6-mobile',
      'Quitoxil7-mobile',
      'Quitoxil8-mobile',
      'Quitoxil9-mobile',
      'Quitoxil10-mobile',
      'Quitoxil11-mobile',
      'Quitoxil12-mobile',
      'Quitoxil13-mobile',
      'Quitoxil14-mobile'
    ],
    'deppart-fr.mdx': [
      'deppart1-mobile',
      'deppart2-mobile',
      'deppart3-mobile',
      'deppart4-mobile',
      'deppart5-mobile',
      'deppart6-mobile',
      'deppart7-mobile'
    ],
    'zparse-fr.mdx': [
      'Zparse1',
      'Zparse2',
      'Zparse3'
    ]
  };
  
  const baseImages = workImageMap[workId] || [];
  const workFolder = workId.replace('-fr.mdx', '');
  
  return baseImages.map((imageName) => {
    const isMobile = imageName.toLowerCase().endsWith('-mobile');
    const oneX = `/images/${workFolder}/${imageName}.png`;
    const retinaName = isMobile
      ? imageName.replace(/-mobile$/i, '@2x-mobile')
      : `${imageName}@2x`;
    const twoX = `/images/${workFolder}/${retinaName}.png`;

    return {
      src: oneX,
      srcSet: `${twoX} 2x, ${oneX} 1x`,
      alt: `${imageName}`,
    };
  });
}

// Get work-specific images
const workImages = getWorkImages(entry.id);

// Build previous/next navigation using same ordering as index page
const works = await getCollection('work');
const sortedWorks = works
  .slice()
  .sort((a, b) => {
    const orderA = typeof a.data.order === 'number' ? a.data.order : Number.POSITIVE_INFINITY;
    const orderB = typeof b.data.order === 'number' ? b.data.order : Number.POSITIVE_INFINITY;
    if (orderA !== orderB) return orderA - orderB; // lower order first
    return (b.data.date || '').localeCompare(a.data.date || '');
  });

const currentIndex = sortedWorks.findIndex((e) => e.id === entry.id);
const prev = currentIndex > 0 ? sortedWorks[currentIndex - 1] : null;
const next = currentIndex < sortedWorks.length - 1 ? sortedWorks[currentIndex + 1] : null;

// No cover image on work pages; covers are shown only on the homepage
---
<BaseLayout title={`${entry.data.summary} — ${entry.data.title}`}>
  <a href="/" aria-label="Fermer et revenir à l'accueil" class="fixed top-6 right-6 z-40 inline-flex h-10 w-10 items-center justify-center rounded-full bg-black text-white shadow-sm transition hover:bg-zinc-800">
    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
      <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
    </svg>
  </a>
  <article class="max-w-5xl mx-auto">
    <header class="mb-14 md:mb-20">
      <h1 class="font-serif text-5xl md:text-7xl leading-[1.05] tracking-tight font-serif text-balance">
        {entry.data.summary}
      </h1>
    </header>

    <section class="grid gap-10 md:grid-cols-3 md:gap-12 mb-16 md:mb-20">
      <div class="md:col-span-2 space-y-10">
        <div>
          <div class="text-sm uppercase tracking-wider text-zinc-500">Client</div>
          <div class="mt-2 text-xl text-zinc-900 font-serif">{entry.data.company || entry.data.title}</div>
          {entry.data.companyDescription && (
            <p class="mt-2 text-zinc-800">{entry.data.companyDescription}</p>
          )}
        </div>
        {entry.data.role && (
          <div>
            <div class="text-sm uppercase tracking-wider text-zinc-500">Rôle</div>
            <div class="mt-2 text-xl text-zinc-900 font-serif">{entry.data.role}</div>
            {entry.data.roleDescription && (
              <p class="mt-2 text-zinc-800">{entry.data.roleDescription}</p>
            )}
          </div>
        )}
        {entry.data.impact && (
          <div>
            <div class="text-sm uppercase tracking-wider text-zinc-500">Impact</div>
            <div class="mt-2 text-xl text-zinc-900 font-serif">{entry.data.impact}</div>
            {entry.data.impactDescription && (
              <p class="mt-2 text-zinc-800">{entry.data.impactDescription}</p>
            )}
          </div>
        )}
      </div>
    </section>

    

    <section class="prose prose-zinc max-w-none mb-20">
      <Content />
    </section>

    {workImages.length > 0 && (
      <section class="mb-20">
        <div class="flex flex-wrap gap-8 justify-center">
          {workImages.map((image: any) => {
            const isMobile = image.alt.toLowerCase().includes('mobile');
            return (
              <figure class={`overflow-hidden rounded-2xl ${isMobile ? 'flex-none' : 'basis-full'}`}>
                <img 
                  src={image.src} 
                  srcSet={image.srcSet}
                  alt={`${entry.data.title} - Image ${image.alt}`}
                  class={`h-auto object-cover ${isMobile ? 'max-w-[375px] mx-auto' : 'w-full'}`}
                />
              </figure>
            );
          })}
        </div>
      </section>
    )}

    <nav class="flex items-center justify-between border-t pt-6">
      <div>
        {prev ? (
          <a href={`/work/${prev.id}`} class="group inline-flex items-center gap-3 text-zinc-700 hover:text-zinc-900">
            <span aria-hidden="true" class="text-lg inline-block transition-transform duration-200 ease-out group-hover:-translate-x-1">←</span>
            <span class="flex flex-col">
              <span class="text-xs uppercase tracking-wider text-zinc-500">Précédent</span>
              <span class="font-medium font-serif text-xl transition-all duration-200 ease-out group-hover:tracking-tight">{prev.data.summary}</span>
            </span>
          </a>
        ) : (
          <span></span>
        )}
      </div>
      <div class="text-right">
        {next && (
          <a href={`/work/${next.id}`} class="group inline-flex items-center gap-3 text-zinc-700 hover:text-zinc-900">
            <span class="flex flex-col text-right">
              <span class="text-xs uppercase tracking-wider text-zinc-500">Suivant</span>
              <span class="font-medium font-serif text-xl transition-all duration-200 ease-out group-hover:tracking-tight">{next.data.summary}</span>
            </span>
            <span aria-hidden="true" class="text-lg inline-block transition-transform duration-200 ease-out group-hover:translate-x-1">→</span>
          </a>
        )}
      </div>
    </nav>
  </article>
</BaseLayout>


