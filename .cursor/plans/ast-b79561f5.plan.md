<!-- b79561f5-8043-41d7-a609-f4c079a3617e 6c3574e5-0c06-4bce-bb5b-6ee708f0af9a -->
# Plan: FR/EN internationalization for the Astro site

## Goals

- EN default at root (`/`), FR under subpath (`/fr`).
- Segments remain English for all languages (e.g., `/work`).
- Initial language = browser preference if supported, else English; redirect only from `/`.
- Localize UI strings and MDX content; graceful fallback to EN.
- Add language switcher and SEO (`hreflang`, `<html lang>`, canonical).

## Routing & detection

- Create `src/middleware.ts` to detect preferred language from cookie (`lang`) → `Accept-Language` → default `en`. If request is to `/`, redirect to `/fr/` when FR preferred; otherwise keep `/`.
  - Ignore static assets and already localized paths.
  - Set/read `lang` cookie when user switches language.
  - Example (concise):
    ```ts
    // src/middleware.ts (sketch)
    export const onRequest = defineMiddleware((ctx, next) => {
      const url = new URL(ctx.request.url);
      if (url.pathname !== '/' || url.pathname.startsWith('/fr/')) return next();
      const cookie = ctx.cookies.get('lang')?.value;
      const accept = ctx.request.headers.get('accept-language') ?? '';
      const preferred = pick(['fr','en'], [cookie, ...parseAccept(accept)] ) || 'en';
      return preferred === 'fr' ? ctx.redirect('/fr/', 302) : next();
    });
    ```

- Duplicate route entries for FR using thin wrappers that pass `locale` to shared pages:
  - Keep existing pages as EN: `src/pages/index.astro`, `src/pages/work/index.astro`, `src/pages/work/[id].astro`.
  - Add FR wrappers:
    - `src/pages/fr/index.astro`
    - `src/pages/fr/work/index.astro`
    - `src/pages/fr/work/[id].astro`
  - Extract the real implementations to shared modules (e.g., `src/pages/_shared/Home.astro`, `WorkIndex.astro`, `WorkDetail.astro`) that accept a `locale` prop.

## i18n utilities & messages

- Add `src/i18n/config.ts`:
  - `supportedLocales = ['en','fr']`, `defaultLocale = 'en'`.
  - Helpers: `getLocaleFromPath(pathname)`, `otherLocale(locale)`.
- Add message dictionaries for UI strings:
  - `src/i18n/messages/en.ts` and `src/i18n/messages/fr.ts` exporting flat objects.
  - Add `src/i18n/t.ts` to expose `t(key, locale)` and type-safe keys.
- In shared pages and components (e.g., `HeroHeader.astro`, `CVSummary.astro`, `ExperimentsGrid.astro`, `WorkCard.astro`), import `t` and pass `locale` from page to component via props.

## Content collections (MDX) localization

- Update `src/content.config.ts` schema to include `locale` (enum: `en|fr`) and a stable `id` for each entry; validate presence.
- Current FR files exist (e.g., `src/content/work/*-fr.mdx`). For consistency:
  - Add frontmatter to existing FR files: `locale: 'fr'`, `id: '<stable-id>'`.
  - Create EN counterparts in the same folder (e.g., `livi-en.mdx`) or, preferably, subfolders `work/en/*.mdx` and `work/fr/*.mdx` (keep current naming if you prefer minimal churn).
- In `src/pages/_shared/WorkIndex.astro` and `WorkDetail.astro`:
  - Fetch entries filtered by `locale`; on miss, fallback to EN.
  - Keep route segment `/work` for both locales; FR pages live under `/fr/work`.

## Layout, SEO, and accessibility

- Edit `src/layouts/BaseLayout.astro`:
  - Set `<html lang={locale}>`.
  - Add `<link rel="alternate" hreflang="en" href={canonicalEn} />` and `<link rel="alternate" hreflang="fr" href={canonicalFr} />` for each page.
  - Ensure `<title>` and meta description use localized strings.
- Ensure `public/robots.txt` remains valid; optionally add sitemaps per locale in future.

## Language switcher

- Create `src/components/LanguageSwitcher.astro`:
  - Computes the counterpart URL by toggling `/fr` prefix while preserving path/query.
  - Sets `lang` cookie on change to prevent re-redirecting.
  - Render clear labels: “English” / “Français”.

## Minimal code changes per file

- `astro.config.mjs`: ensure `site` is set; no experimental i18n needed.
- `src/middleware.ts`: add redirect logic from `/` only.
- `src/i18n/*`: new utilities and messages.
- `src/pages/fr/*`: FR wrappers.
- `src/pages/_shared/*`: extracted shared pages receiving `locale`.
- `src/layouts/BaseLayout.astro`: set `lang`, `hreflang`, localized meta.
- Components: read `locale` via props; replace literals by `t('key', locale)`.
- Content MDX: add `locale` and `id` frontmatter; add EN files.

## Testing & validation

- Manual checks: visit `/`, `/work`, `/work/<id>`, `/fr`, `/fr/work`, `/fr/work/<id>` with browser set to EN/FR; verify redirect only from `/`.
- Unit tests (optional): small tests for URL toggle and `parseAcceptLanguage`.
- SEO check: verify `hreflang` alternates and `<html lang>`.

## Risks & mitigations

- Missing EN/FR content → implement runtime fallback to EN and surface console warn.
- Redirect loops → restrict redirect to `/` only.
- Stale links → switcher preserves path/query; add 301s only if needed later.

### To-dos

- [ ] Add middleware and FR route wrappers; extract shared pages
- [ ] Create i18n config, messages, and t() helper
- [ ] Update BaseLayout for lang attribute and hreflang alternates
- [ ] Replace hardcoded strings with t() and wire locale props
- [ ] Add locale/id frontmatter and EN counterparts; filter by locale
- [ ] Add LanguageSwitcher and cookie handling
- [ ] Run cross-locale QA and verify redirects and SEO tags